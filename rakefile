SRCS = Dir.glob('src/**/*.cr')
SPECS = Dir.glob('spec/**/*.cr')
EXES = Dir.glob('exe/*.cr')
BINS = EXES.map { |f| f.sub('.cr', '').sub('exe', 'bin') }

task default: %i[clean spec install]

BINS.each do |bin|
  task File.basename(bin) => :install do
    sh bin
  end
end

task :clean do
  sh 'rm -rfv tmp bin'
end

task :install do
	sh 'shards install'
	sh 'shards build'
end

task spec: :install do
	sh 'crystal spec -v'
end

task :fmt do
  (SRCS + EXES + SPECS).each do |f|
	  sh "crystal tool format #{f}"
  end
end
task :lint => :fmt

task :sample => %w[sample/main.c] do |t|
  flags = %w[
    -S
    -masm=intel
    -O0
    -o /dev/stdout

    -Wall
    -Wextra

    -fno-asynchronous-unwind-tables
    -fno-exceptions
    -fno-ident
    -finhibit-size-directive
    -Wl,-z,noexecstack
  ].join(" ")
  sh "gcc #{flags} #{t.source}"
end

## asm

nasm = 'third_party/nasm/nasm'
desc 'build local nasm'
task :nasm => nasm do
	sh "#{nasm} -v"
end

file nasm do
  Dir.chdir 'third_party/nasm' do
	  sh 'sh autogen.sh'
	  sh 'sh configure'
    sh 'make'
    sh 'make strip'
  end
end
